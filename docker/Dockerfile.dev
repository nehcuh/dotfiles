# Development Docker image with all tools
FROM ubuntu:22.04

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    sudo \
    zsh \
    stow \
    && rm -rf /var/lib/apt/lists/*

# Create user
ARG USERNAME=developer
ARG USER_UID=1000
ARG USER_GID=$USER_UID

RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

# Switch to user
USER $USERNAME
WORKDIR /home/$USERNAME

# Install Homebrew
RUN /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
ENV PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"

# Install development tools via Homebrew
RUN brew install \
    neovim \
    tmux \
    ripgrep \
    fd \
    bat \
    fzf \
    eza \
    git-delta \
    starship \
    zoxide \
    go \
    rust \
    node \
    python@3.11

# Install Java
RUN brew install openjdk@17
RUN echo 'export PATH="/home/linuxbrew/.linuxbrew/opt/openjdk@17/bin:$PATH"' >> ~/.zshenv

# Copy dotfiles
COPY --chown=$USERNAME:$USERNAME . /home/$USERNAME/.dotfiles

# Install dotfiles
RUN cd /home/$USERNAME/.dotfiles && \
    ./scripts/stow.sh install system zsh git tools vim nvim tmux

# Install Zinit
RUN sh -c "$(curl -fsSL https://git.io/zinit-install)"

# Set zsh as default shell
RUN sudo chsh -s $(which zsh) $USERNAME

# Set working directory
WORKDIR /workspace

CMD ["zsh"]